<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="files/style.css">
    <link rel="stylesheet" href="files/index.css">
    <link rel="stylesheet" href="files/login.css">
    <title>KrokyPlus</title>
</head>
<body>
    
    <div class="title">
        <h1>KrokyPlus</h1>
    </div>
    <div class="text">
        <p>Na tej spletni strani se lahko prijavite v bota za avtomatsko naročanje malice.</p>
    </div>
    <div class="log-form">
        <h2>Prijava</h2>
        <form>
            <input type="text" id="username" title="Uporabniško ime" placeholder="Uporabniško ime ali E-pošta" />
            <input type="password" id="password" title="Geslo" placeholder="Geslo" />
            <button type="submit" class="btn" id="commit" onclick="getMenu()">Prijava</button>
            <a class="register" href="register">Registracija</a>
        </form>
    </div>
    <footer>
        <a href="https://github.com/jakecernet/KrokyPlus" target="_blank">© 2023 KrokyPlus</a>
        <div class="footer-text">
            <ul>
                <li><a href="user-area">Uporabniško območje</a></li>
                <li><a href="register">Registracija</a></li>
                <li><a href="index">Prijava</a></li>
                <li><a href="https://github.com/jakecernet/KrokyPlus">O tem projektu</a></li>
            </ul>
        </div>
    </footer>


    <script>
        function getMenu() {
  const https = require('https');

  const DAY = new Date().getDay() - 1;

  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;

  const loginData = new URLSearchParams({
    username,
    password,
  }).toString();

  const options = {
    hostname: 'www.kroky.si',
    path: '/2016/?mod=register&action=login',
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'Content-Length': loginData.length,
    },
  };

  let ac;

  try {
    const req = https.request(options, (res) => {
      const cookies = res.headers['set-cookie'];
      ac = cookies[0].match(/PHPSESSID=(\w+);?/)[1];

      if (!ac) {
        console.error('Login failed');
        alert('Login failed');
        return;
      }

      options.path = '/2016/?mod=register&action=order&pos=-1';
      options.headers = {
        cookie: `PHPSESSID=${ac}`,
      };

      https.get(options, (res) => {
        let data = '';

        res.on('data', (chunk) => {
          data += chunk;
        });

        res.on('end', () => {
          const menus = data.match(/<span class="lepo_ime">([^<]+)<\/span>/g).map((m) => m.replace(/<[^>]+>/g, ''));
          const selected = data.match(/menu_id="(\d{1})".*checked/)[1];

          const result = menus[(selected - 1) * 5 + DAY];
          alert(result);
        });
      }).on('error', (err) => {
        console.error(err);
        alert(err.message);
      });
    });

    req.on('error', (err) => {
      console.error(err);
      alert(err.message);
    });

    req.write(loginData);
    req.end();
  } catch (err) {
    console.error(err);
    alert(err.message);
  }
}


    </script>
</body>
</html>